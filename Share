// File: Pages/Index.razor
@page "/"
@inject HttpClient Http

<h1>StarTrends Dashboard</h1>
<p>Below is the latest Product Trades chart:</p>

@if (metadata == null)
{
    <p>Loading chart...</p>
}
else
{
    <img src="@metadata.ImageUrl" alt="Product Trades Chart" style="max-width:100%; height:auto;" />
    <p><small>Last updated: @metadata.LastUpdated.ToLocalTime().ToString("f")</small></p>
    <button class="btn btn-outline-primary" @onclick="RefreshChart" disabled="@isRefreshing">
        @(isRefreshing ? "Refreshingâ€¦" : "Refresh")
    </button>
    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger mt-2">@error</div>
    }
}

@code {
    private ChartMeta metadata;
    private bool isRefreshing;
    private string error;

    protected override async Task OnInitializedAsync()
    {
        metadata = await Http.GetFromJsonAsync<ChartMeta>("/api/charts/metadata");
    }

    private async Task RefreshChart()
    {
        isRefreshing = true;
        error = null;
        try
        {
            var resp = await Http.PostAsync("/api/charts/productTrade/refresh", null);
            resp.EnsureSuccessStatusCode();
            metadata = await resp.Content.ReadFromJsonAsync<ChartMeta>();
        }
        catch (Exception ex)
        {
            error = "Could not refresh chart: " + ex.Message;
        }
        finally
        {
            isRefreshing = false;
        }
    }

    public class ChartMeta
    {
        public string ImageUrl { get; set; }
        public DateTime LastUpdated { get; set; }
    }
}
