@inject HttpClient Http
@inject NavigationManager Nav

<div class="chart-container">
  <img 
    src="@_chartUrl" 
    alt="OTC Product Types Chart" 
    style="max-width:100%; display:block; margin-bottom:0.5rem;" />

  <button class="btn btn-sm btn-outline-primary mt-2" @onclick="RefreshChart" disabled="@_loading">
    @(_loading ? "Refreshing…" : "↻ Refresh")
  </button>
</div>

@code {
  private string _chartUrl = "";
  private bool   _loading  = false;

  protected override void OnInitialized()
  {
    // Set initial URL
    _UpdateChartUrl();
  }

  private void _UpdateChartUrl()
  {
    // Build an absolute URL so HttpClient.GetAsync will go to the right place
    _chartUrl = $"{Nav.BaseUri}charts/otc-product-types.png?ts={DateTimeOffset.UtcNow.ToUnixTimeSeconds()}";
  }

  private async Task RefreshChart()
  {
    _loading = true;
    StateHasChanged();

    // IMPORTANT: use absolute URL here
    var refreshUrl = $"{Nav.BaseUri}api/graphs/refresh-otc-chart";
    var resp = await Http.GetAsync(refreshUrl);

    if (resp.IsSuccessStatusCode)
    {
      // bump the cache-buster so the browser will re-fetch
      _UpdateChartUrl();
    }
    else
    {
      // optionally handle error (e.g. show toast)
      Console.Error.WriteLine($"Refresh failed: {resp.StatusCode}");
    }

    _loading = false;
    StateHasChanged();
  }
}
